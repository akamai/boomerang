<%= header %>
<!--
	Tests xhr:all with ignore:true param
-->
<%= boomerangScript %>
<script src="17-page-params-xhr-ignore.js" type="text/javascript"></script>
<script>
var t = BOOMR_test;

BOOMR_test.init({
	testAfterOnBeacon: BOOMR.plugins.AutoXHR ? (t.isFetchApiSupported() ? 3 : 2) : 1,
	onBoomerangLoaded: function() {
		if (!BOOMR.plugins.AutoXHR) {
			return;
		}

		setTimeout(function() {
			// send xhr before page load
			var xhr = new XMLHttpRequest();
			// will be ignored
			xhr.open("GET", "/delay?id=1a&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
			xhr.send(null);

			if (t.isFetchApiSupported()) {
				// will be ignored
				var f = fetch("/delay?id=1&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
				f.then(function(response) { response.text(); });
			}
		}, 100);

		BOOMR.subscribe("page_ready", function() {
			// this will cause an xhr and a fetch to start between sendBeacon and real_sendBeacon for the page view beacon
			var xhr = new XMLHttpRequest();
			// will be ignored
			xhr.open("GET", "/delay?id=1b&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
			xhr.send(null);

			if (t.isFetchApiSupported()) {
				// will be ignored
				var f = fetch("/delay?id=1b&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
				f.then(function(response) { response.text(); });
			}
		});

		BOOMR.subscribe("xhr_load", function(evt) {
			if (evt.url.match(/id=2/)) {
				// this will cause an xhr and a fetch to start between sendBeacon and real_sendBeacon for the xhr beacon
				var xhr = new XMLHttpRequest();
				// will be ignored
				xhr.open("GET", "/delay?id=1d&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
				xhr.send(null);

				if (t.isFetchApiSupported()) {
					// will be ignored
					var f = fetch("/delay?id=1d&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
					f.then(function(response) { response.text(); });
				}
			}
		});
	},
	afterFirstBeacon: function() {
		if (!BOOMR.plugins.AutoXHR) {
			return;
		}
		setTimeout(function() {
			setTimeout(function() {
				var xhr1 = new XMLHttpRequest();
				// will be ignored
				xhr1.open("GET", "/delay?id=1c&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
				xhr1.send(null);
			}, 0);
			setTimeout(function() {
				// will cause a beacon
				var xhr2 = new XMLHttpRequest();
				xhr2.open("GET", "/delay?id=2&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
				xhr2.send(null);
			}, 1000);

			if (t.isFetchApiSupported()) {
				setTimeout(function() {
					// will be ignored
					var f1 = fetch("/delay?id=1c&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
					f1.then(function(response) { response.text(); });
				}, 2000);

				setTimeout(function() {
					// will cause a beacon
					var f2 = fetch("/delay?id=2&delay=500&file=/pages/04-page-params/support/img.jpg&rnd=" + Math.random());
					f2.then(function(response) { response.text(); });
				}, 3000);
			}
		}, 100);
	},
	AutoXHR: {
		alwaysSendXhr: true,
		monitorFetch: true
	},
	PageParams: {
		xhr: "all",
		pageGroups: [
			{
				type: "Regexp",
				parameter1: ".*/17-page-params-xhr-ignore.html",
				parameter2: "Test Page",
				on: ["navigation"]
			},
			{
				type: "Regexp",
				parameter1: ".*id=1.*",
				parameter2: "XHR Test Page 1",
				ignore: true
			}
		]
	},
	instrument_xhr: true
});
</script>
<!-- delay page load -->
<img src="/delay?id=-1&delay=5500&file=/pages/04-page-params/support/img.jpg">
<%= footer %>
