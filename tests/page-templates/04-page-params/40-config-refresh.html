<%= header %>
<!--
	This test repro's a timing issue that was causing the XHR beacon's page group to be overwritten:
	* An XHR request completes
	* xhr_load event fires
	* PageParams runs the page group handler
	* sendBeacon is called and sets a timeout to call real_sendBeacon
	* A config refresh response is received
	* BOOMR.init is called with the config refresh
	* PageParams was re-initialing and reseting the page group using the URL of the base page
-->
<%= boomerangScript %>
<script src="40-config-refresh.js" type="text/javascript"></script>
<script>
var t = BOOMR_test;

BOOMR_test.init({
	testAfterOnBeacon: BOOMR.plugins.AutoXHR ? 2 : 1,
	afterFirstBeacon: function() {
		if (!BOOMR.plugins.AutoXHR) {
			return;
		}
		setTimeout(function() {
			// since we're subscribing late, we should be the last handler
			// to run (after the PageParams `done` function has handled the event).
			// Call `BOOMR.init` to simulate a config refresh that ended at the same time
			BOOMR.subscribe("xhr_load", function() { BOOMR.init({}); }, null, null, true);

			var xhr1 = new XMLHttpRequest();
			xhr1.open("GET", "/delay?id=1&delay=500&file=/pages/04-page-params/support/img.jpg");
			xhr1.send(null);
		}, 100);
	},
	AutoXHR: {
		alwaysSendXhr: true
	},
	PageParams: {
		xhr: "all",
		pageGroups: [
			{
				type: "Regexp",
				parameter1: ".*/40-config-refresh.html",
				parameter2: "Test Page",
				on: ["navigation"]
			},
			{
				type: "Regexp",
				parameter1: ".*id=1.*",
				parameter2: "XHR Test Page 1",
				on: ["xhr"]
			}
		]
	},
	instrument_xhr: true
});
</script>
<%= footer %>
